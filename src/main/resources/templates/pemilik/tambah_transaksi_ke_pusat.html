<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css" th:href="@{/style.css}">
    <!-- <script src="@{/script.js}" defer></script> -->
</head>
<body>
    <header> 
        <a th:href="@{/pemilik/transaksiKePusat}" style="text-decoration: none; font-size: 20px;">&#8592;</a>
        <h1>Penyetoran Sampah ke Pusat</h1> 
    </header>

    <main class="tambah">
        <section class="card-container">
            <div th:each="keterangan : ${listKet}" class="card" th:data-nama="${keterangan.nama}" th:data-harga="${keterangan.harga}" th:data-satuan="${keterangan.satuanKuantitas}" th:data-kuantitas="${keterangan.kuantitas}">
                <div class="keteranganCard">
                    <h3 th:text="${keterangan.nama}"></h3>
                    <p>Harga: <span th:text="${keterangan.harga}"></span>/<span th:text="${keterangan.satuanKuantitas}"></span></p>
                </div>
                <p>Stok saat ini: <span th:text="${keterangan.kuantitas}"></span></p>
                
                <div class="number-input">
                    Kuantitas:
                    <input type="number" id="number" value="0" min="0" th:max="${keterangan.kuantitas}" />
                </div>
            </div>
        </section>

        <!-- Display selected items summary here with visible inputs -->
        <section class="summary">
            <h2>Summary</h2>
            <ul id="selected-items-list">
                <!-- Selected items will appear here -->
            </ul>
            <form method="post" action="/pemilik/tambahTransaksiKePusat/add">
                <!-- Hidden inputs will now be added with user-modified quantities -->
                <button type="submit">Setor Sampah</button>
            </form>
        </section>
        
        <!-- <section class="tambahMember">
            <h2>Setor Sampah</h2>
            <form method="post">
                Hidden inputs will now be added with user-modified quantities
                <button type="submit">Setor Sampah</button>
            </form>
        </section> -->
    </main>

    <footer>
        <p>&copy; 2024 Bank Sampah Daur Ulang. All rights reserved.</p>
    </footer> 
    <script>
        // Get all the card elements
        const cards = document.querySelectorAll('.card');

        // Get form for submitting data
        const form = document.querySelector('form');

        // Get the container to display selected items
        const selectedItemsList = document.getElementById('selected-items-list');

        // Track selected items
        let selectedItemsData = [];

        // Event listener for each card
        cards.forEach(card => {
            card.addEventListener('click', function() {
                // Get data from the clicked card
                const nama = card.getAttribute('data-nama');
                const harga = card.getAttribute('data-harga');
                const satuan = card.getAttribute('data-satuan');
                const kuantitas = card.getAttribute('data-kuantitas');
                const inputKuantitas = card.querySelector('input').value; // Get the value from input

                // Find if the item is already selected
                const selectedItemIndex = selectedItemsData.findIndex(item => item.nama === nama);

                if (selectedItemIndex !== -1) {
                    // If item is already selected, update quantity or remove if it's 0
                    if (inputKuantitas == 0) {
                        // Remove item from the selected items list and summary if quantity is 0
                        selectedItemsData.splice(selectedItemIndex, 1);
                        removeItemFromSummary(nama);
                        // Reset the input value on the card to 0 as well
                        card.querySelector('input').value = 0;
                    } else {
                        // Update the quantity of the selected item
                        selectedItemsData[selectedItemIndex].kuantitas = inputKuantitas;
                        updateItemInSummary(nama, inputKuantitas);
                    }
                } else {
                    // If the item is not in the selected list, add it
                    if (inputKuantitas > 0) {
                        selectedItemsData.push({
                            nama,
                            harga,
                            satuan,
                            kuantitas: inputKuantitas
                        });
                        addItemToSummary(nama, harga, satuan, kuantitas, inputKuantitas);
                    }
                }

                // Update the hidden inputs for form submission
                updateFormInputs();
            });
        });

        // Add item to the summary list
        function addItemToSummary(nama, harga, satuan, kuantitas, inputKuantitas) {
            const listItem = document.createElement('li');
            listItem.dataset.nama = nama;

            const strong = document.createElement('strong');
            strong.textContent = nama;

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.classList.add('quantity-input');
            quantityInput.value = inputKuantitas;
            quantityInput.min = 0;

            // When the quantity in the summary changes, update the item in the selected items array and the card input
            quantityInput.addEventListener('input', function () {
                const quantity = parseInt(quantityInput.value, 10);
                if (quantity === 0) {
                    // If quantity becomes 0, remove item
                    selectedItemsData = selectedItemsData.filter(item => item.nama !== nama);
                    selectedItemsList.removeChild(listItem);
                    // Reset the quantity in the card input field as well
                    const card = document.querySelector(`.card[data-nama="${nama}"]`);
                    if (card) {
                        card.querySelector('input').value = 0;
                    }
                } else {
                    // Update the quantity in the list and in the selected items data
                    const selectedItem = selectedItemsData.find(item => item.nama === nama);
                    selectedItem.kuantitas = quantity;
                    // Update the corresponding card input field
                    const card = document.querySelector(`.card[data-nama="${nama}"]`);
                    if (card) {
                        card.querySelector('input').value = quantity;
                    }
                }
                updateFormInputs();
            });

            const spanStok = document.createElement('span');
            spanStok.textContent = `Stok: ${kuantitas}`;

            listItem.appendChild(strong);
            listItem.appendChild(document.createTextNode(` - Harga: ${harga}/${satuan} - `));
            listItem.appendChild(quantityInput);
            listItem.appendChild(spanStok);

            selectedItemsList.appendChild(listItem);
        }

        // Update item in the summary list if the quantity changes
        function updateItemInSummary(nama, kuantitas) {
            const item = selectedItemsList.querySelector(`li[data-nama="${nama}"]`);
            if (item) {
                const quantityInput = item.querySelector('.quantity-input');
                quantityInput.value = kuantitas;
            }
        }

        // Remove item from the summary list
        function removeItemFromSummary(nama) {
            const item = selectedItemsList.querySelector(`li[data-nama="${nama}"]`);
            if (item) {
                selectedItemsList.removeChild(item);
            }
        }

        // Function to update the form with selected items
        function updateFormInputs() {
            // Clear any existing hidden inputs
            form.querySelectorAll('input[type="hidden"]').forEach(input => input.remove());

            // Get the selected items and add them to the form
            selectedItemsData.forEach(item => {
                const inputNama = document.createElement('input');
                inputNama.type = 'hidden';
                inputNama.name = 'nama[]';
                inputNama.value = item.nama;

                const inputHarga = document.createElement('input');
                inputHarga.type = 'hidden';
                inputHarga.name = 'harga[]';
                inputHarga.value = item.harga;

                const inputSatuan = document.createElement('input');
                inputSatuan.type = 'hidden';
                inputSatuan.name = 'satuan[]';
                inputSatuan.value = item.satuan;

                const inputKuantitas = document.createElement('input');
                inputKuantitas.type = 'hidden';
                inputKuantitas.name = 'kuantitas[]';
                inputKuantitas.value = item.kuantitas;

                // Append the new hidden inputs to the form
                form.appendChild(inputNama);
                form.appendChild(inputHarga);
                form.appendChild(inputSatuan);
                form.appendChild(inputKuantitas);
            });
        }

    </script>
</body>
</html>
